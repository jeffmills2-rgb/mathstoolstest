<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stacked Bar Model – Ratio</title>
  <style>
    :root {
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --blue:#2563eb;
      --red:#dc2626;
      --purple:#a855f7;
      --accent:#22c55e;
      --green:#16a34a;
      --error:#ef4444;
      --orange:#f97316;
      --orange-deep:#ea580c;
      --orange-soft:#fff7ed;
      --quiz-pink:#ec4899;
      --quiz-pink-deep:#db2777;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    body.fullscreen-active{
      overflow:hidden;
    }
    .wrap{
      max-width:1100px;
      margin:32px auto;
      padding:0 16px;
    }
    .card{
      position:relative;
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
      padding:28px 26px 24px;
    }

    /* FULLSCREEN STATE -------------------------------------------------- */
    .card.fullscreen{
      position:fixed;
      inset:12px;
      max-width:none;
      margin:0;
      z-index:1000;
      padding:28px 32px 24px;
    }
    .card.fullscreen .mode-column,
    .card.fullscreen .type-column{
      display:none;
    }
    .card.fullscreen .layout{
      justify-content:center;
    }
    .card.fullscreen .main-column{
      max-width:1200px;
      margin:0 auto;
    }

    .layout{
      display:flex;
      gap:32px;
    }
    .mode-column{
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* type-column sits to the right of mode-column */
    .type-column{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding-left:8px;
      padding-right:8px;
    }
    .type-column-inner{
      display:flex;
      flex-direction:column;
      gap:12px;
      height:auto;
      justify-content:flex-start;
    }

    .main-column{
      flex:1;
      min-width:0;
    }

    h1{
      margin:0 0 18px;
      font-size:26px;
      text-align:left;
    }

    /* MODE BAR (banner + fullscreen button) ----------------------------- */
    .mode-bar{
      position:absolute;
      top:18px;
      right:22px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .mode-banner{
      font-size:18px;
      padding:6px 18px;
      border-radius:999px;
      max-width:260px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border:1px solid transparent;
      color:#fff;
      text-align:center;
    }
    .mode-banner.demo{
      background:linear-gradient(145deg,#2563eb,#1d4ed8);
    }
    .mode-banner.practice{
      background:linear-gradient(145deg,#fb923c,#f97316);
    }
    .mode-banner.quiz{
      background:linear-gradient(145deg,#ec4899,#db2777);
    }

    /* FULLSCREEN TOGGLE BUTTON ----------------------------------------- */
    .fullscreen-btn{
      border:none;
      border-radius:999px;
      padding:8px 20px;
      font-size:14px;
      font-weight:600;
      background:var(--accent);
      color:#ffffff;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(34,197,94,0.4);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        background-color 0.12s ease;
    }
    .fullscreen-btn:hover{
      background:#16a34a;
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(34,197,94,0.55);
    }
    .card.fullscreen .fullscreen-btn{
      /* keep same style in fullscreen */
    }

    /* Left side big mode buttons --------------------------------------- */
    .side-mode-btn{
      width:130px;
      height:120px;
      border-radius:40px;
      border:none;
      cursor:pointer;
      font-size:20px;
      font-weight:700;
      color:#fff;
      box-shadow:0 18px 40px rgba(15,23,42,0.20);
      opacity:0.35;
      transition:
        opacity 0.15s ease,
        transform 0.12s ease,
        box-shadow 0.12s ease;
    }
    .side-mode-demo{
      background:linear-gradient(145deg,#2563eb,#1d4ed8);
    }
    .side-mode-practice{
      background:linear-gradient(145deg,#fb923c,#f97316);
    }
    .side-mode-quiz{
      background:linear-gradient(145deg,#ec4899,#db2777);
    }
    .side-mode-btn.active{
      opacity:1;
      transform:translateY(-2px);
      box-shadow:0 22px 45px rgba(15,23,42,0.28);
    }
    .side-mode-btn:hover{
      opacity:0.8;
    }

    /* Type selector buttons -------------------------------------------- */
    .type-selector{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:20px;
    }
    .type-btn{
      width:220px;
      border-radius:18px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      cursor:pointer;
      padding:8px 14px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      box-shadow:0 4px 10px rgba(15,23,42,0.05);
      transition:
        background 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.12s ease,
        border-color 0.15s ease;
      text-align:left;
    }
    .type-main{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .type-sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .type-btn.active{
      background:#020617;
      border-color:#020617;
      color:#f9fafb;
      box-shadow:0 10px 24px rgba(15,23,42,0.45);
      transform:translateY(-1px);
    }
    .type-btn.active .type-sub{
      color:#e5e7eb;
    }

    .question{
      text-align:center;
      font-size:40px;
      margin-bottom:12px;
      line-height:1.4;
    }
    .card.fullscreen .question{
      font-size:44px;
    }
    .question-amount{
      font-weight:700;
      white-space:nowrap;
    }
    .question-ratio{
      font-weight:700;
      white-space:nowrap;
    }
    .ratio-left{ color:var(--blue); }
    .ratio-right{ color:var(--red); }

    .question-tools{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:14px;
      gap:16px;
      width:100%;
    }
    .progress{
      display:flex;
      justify-content:center;
      gap:22px;
      font-size:12px;
      color:var(--muted);
    }
    .step{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
    }
    .step-circle{
      width:22px;
      height:22px;
      border-radius:999px;
      border:2px solid #d1d5db;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
      background:#ffffff;
      transition:border-color 0.2s ease, background 0.2s ease, color 0.2s ease, transform 0.15s ease;
    }
    .step-label{
      white-space:nowrap;
    }
    .step.active .step-circle{
      border-color:var(--accent);
      background:#dcfce7;
      color:#166534;
      transform:scale(1.05);
    }
    .step.completed .step-circle{
      background:var(--accent);
      border-color:var(--accent);
      color:#ffffff;
    }

    .controls{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:22px;
      align-items:center;
    }
    .btn{
      border-radius:999px;
      padding:9px 18px;
      border:1px solid #d1d5db;
      background:#ffffff;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      color:#111827;
      box-shadow:0 2px 6px rgba(15,23,42,0.06);
    }
    .btn.primary{
      background:var(--accent);
      border-color:#16a34a;
      color:#ffffff;
      box-shadow:0 4px 12px rgba(34,197,94,0.45);
    }
    .btn.primary:hover:not([disabled]){
      background:#16a34a;
    }
    .btn[disabled]{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn.back-btn{
      padding:8px 10px;
      min-width:32px;
      font-size:14px;
      font-weight:700;
    }

    .model-area{
      margin-top:6px;
      min-height:160px;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
    }
    .card.fullscreen .model-area{
      min-height:220px;
    }
    .model-area::before{
      content:"";
      position:absolute;
      inset:0 24px;
      border-radius:18px;
      background-image:
        radial-gradient(circle at 0 0, rgba(148,163,184,0.18) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(148,163,184,0.12) 0, transparent 55%);
      opacity:0.4;
      pointer-events:none;
      z-index:0;
    }

    .bars{
      display:flex;
      flex-direction:column;
      gap:8px;
      width:100%;
      max-width:1000px;
      margin:0 auto;
      padding:12px 16px;
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 4px 14px rgba(15,23,42,0.10);
      opacity:0;
      transform:translateY(10px) scale(0.97);
      position:relative;
      z-index:1;
    }
    @keyframes barReveal{
      0% {
        opacity:0;
        transform:translateY(12px) scale(0.97);
        box-shadow:0 18px 40px rgba(15,23,42,0.25);
      }
      60% {
        opacity:1;
        transform:translateY(0) scale(1.02);
        box-shadow:0 10px 26px rgba(15,23,42,0.16);
      }
      100% {
        opacity:1;
        transform:translateY(0) scale(1);
        box-shadow:0 8px 20px rgba(15,23,42,0.12);
      }
    }
    .bars.show{
      animation:barReveal 0.35s ease-out forwards;
    }

    .bar-row{
      display:flex;
      height:60px;
      gap:6px;
      position:relative;
    }

    .segment{
      flex:1;
      border:2px solid;
      border-radius:12px;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:20px;
      transition:
        background 0.2s ease,
        color 0.2s ease,
        border-color 0.2s ease,
        box-shadow 0.2s ease,
        transform 0.1s ease,
        opacity 0.2s ease;
    }

    .top-row .segment{
      border-color:#3b82f6;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .top-row .segment[data-active="true"]{
      box-shadow:0 3px 8px rgba(37,99,235,0.18);
    }

    .bottom-row .segment{
      border-color:#ef4444;
      background:#fef2f2;
      color:#b91c1c;
    }
    .bottom-row .segment[data-active="true"]{
      box-shadow:0 3px 8px rgba(239,68,68,0.18);
    }

    .segment.gap-cell{
      border-color:var(--purple);
      background:#f5f3ff;
      color:#7e22ce;
    }
    .segment.gap-cell[data-active-gap="true"]{
      box-shadow:0 3px 8px rgba(168,85,247,0.22);
    }

    .segment.filler{
      border-color:transparent !important;
      background:transparent !important;
      color:transparent !important;
      box-shadow:none !important;
    }

    .segment.practice-dim{ opacity:0.32; }
    .segment.practice-target{
      box-shadow:0 0 0 3px rgba(34,197,94,0.75);
    }

    .segment[data-active="true"]:hover,
    .segment[data-active-gap="true"]:hover{
      box-shadow:0 0 0 2px rgba(15,23,42,0.08);
      transform:translateY(-1px);
    }
    .top-row .segment[data-active="true"]:hover{ background:#dbeafe; }
    .bottom-row .segment[data-active="true"]:hover{ background:#fee2e2; }
    .segment.gap-cell[data-active-gap="true"]:hover{ background:#ede9fe; }

    .segment.touched{
      box-shadow:0 0 0 3px rgba(56,189,248,0.8);
      transform:translateY(-1px);
    }

    @keyframes popPart{
      0%   { transform:scale(0.8); opacity:0; }
      60%  { transform:scale(1.08); opacity:1; }
      100% { transform:scale(1);    opacity:1; }
    }
    .segment.pop{
      animation:popPart 0.25s ease-out;
    }

    .segment.correct{
      box-shadow:0 0 0 3px rgba(34,197,94,0.9) !important;
      opacity:1;
    }
    .segment.incorrect{
      box-shadow:0 0 0 3px rgba(248,113,113,0.95) !important;
      opacity:1;
    }

    .answer-area{
      margin-top:24px;
      text-align:center;
      min-height:40px;
      font-size:20px;
      transition:box-shadow 0.3s ease, background 0.3s ease;
    }
    .answer-text{
      font-size:22px;
      font-weight:600;
    }
    .answer-left{
      color:var(--blue);
      font-weight:700;
    }
    .answer-right{
      color:var(--red);
      font-weight:700;
    }

    .answer-input{
      width:90px;
      padding:6px 8px;
      border-radius:10px;
      border:2px solid #d1d5db;
      font-size:18px;
      text-align:center;
      margin:0 10px 12px;
    }
    .answer-input.correct{
      border-color:var(--green);
      background:#dcfce7;
    }
    .answer-input.incorrect{
      border-color:var(--error);
      background:#fee2e2;
    }

    @keyframes answerGlow{
      0%   { box-shadow:0 0 0 0 rgba(250,204,21,0.0); background:transparent; }
      40%  { box-shadow:0 0 20px 4px rgba(250,204,21,0.6); background:#fef9c3; }
      100% { box-shadow:0 0 0 0 rgba(250,204,21,0.0); background:transparent; }
    }
    .answer-glow{
      animation:answerGlow 1.1s ease-out;
    }

    .footer-note{
      margin-top:14px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    .part-input{
      width:80%;
      border:none;
      background:transparent;
      text-align:center;
      font-size:inherit;
      font-weight:inherit;
      color:inherit;
      outline:none;
    }

    .quiz-meta{
      text-align:center;
      font-size:16px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .quiz-prompt{
      margin-top:8px;
      font-size:26px;
      text-align:center;
    }
    .quiz-error{
      margin-top:10px;
      font-size:18px;
      color:var(--error);
    }

    .quiz-controls{
      display:none;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }
    .quiz-active .quiz-controls{
      display:flex;
    }

    .btn:focus-visible{
      outline:3px solid #2563eb;
      outline-offset:2px;
    }
    .part-input:focus-visible,
    .answer-input:focus-visible{
      outline:2px solid #2563eb;
      outline-offset:2px;
    }

    /* Hide various UI in quiz mode ------------------------------------ */
    .quiz-active .controls,
    .quiz-active .model-area,
    .quiz-active .footer-note,
    .quiz-active .question-tools{
      display:none;
    }

    .quiz-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .quiz-overlay.show{ display:flex; }
    .quiz-overlay-card{
      background:#ffffff;
      border-radius:24px;
      padding:26px 32px 24px;
      max-width:420px;
      width:90%;
      text-align:center;
      box-shadow:0 24px 60px rgba(15,23,42,0.5);
    }
    .quiz-overlay-title{
      font-size:26px;
      margin-bottom:8px;
    }
    .quiz-overlay-score{
      font-size:22px;
      margin-bottom:8px;
    }
    .quiz-overlay-msg{
      font-size:18px;
      color:var(--muted);
      margin-bottom:18px;
    }

    /* EXTRA SPACE: move model panel down ONLY in normal mode ---------- */
    .card:not(.fullscreen) .model-area{
      margin-top:40px;
    }

    @media (max-width:1000px){
      .layout{
        flex-direction:column;
      }
      .mode-column{
        flex-direction:row;
        justify-content:flex-start;
        gap:18px;
      }
      .type-column{
        margin-top:18px;
      }
      .type-column-inner{
        height:auto;
        gap:10px;
      }
      .side-mode-btn{
        width:110px;
        height:80px;
        border-radius:28px;
        font-size:18px;
      }
      .question{
        font-size:32px;
      }
    }

    @media (max-width:600px){
      h1{font-size:22px;}
      .question{font-size:28px;}
      .segment{font-size:18px;}
      .answer-text{font-size:20px;}

      .mode-bar{
        position:static;
        margin:6px auto 4px;
        justify-content:center;
      }

      .layout{
        gap:18px;
      }
    }
  </style>

</head>
<body>
  <div class="wrap">
    <div class="card" id="cardRoot">

      <div class="mode-bar">
        <div id="modeBanner" class="mode-banner demo">
          Demo Mode Activated
        </div>
        <button id="fullscreenBtn" class="fullscreen-btn" type="button" title="Enter full screen" aria-label="Enter full screen">
          Full screen
        </button>
      </div>

      <h1>Stacked Bar Model – Ratio</h1>

      <div class="layout">
        <!-- Left column: big mode buttons -->
        <div class="mode-column">
          <button id="sideDemoBtn" class="side-mode-btn side-mode-demo active" type="button">Demo</button>
          <button id="sidePracticeBtn" class="side-mode-btn side-mode-practice" type="button">Practice</button>
          <button id="sideQuizBtn" class="side-mode-btn side-mode-quiz" type="button">Quiz</button>
        </div>

        <!-- Type selector column -->
        <div class="type-column">
          <div class="type-column-inner">
            <div class="type-selector">
              <button class="type-btn active" data-mode="type1">
                <div class="type-main">Type 1</div>
                <div class="type-sub">Share a total<br>in a ratio</div>
              </button>
              <button class="type-btn" data-mode="type2">
                <div class="type-main">Type 2</div>
                <div class="type-sub">One person's share<br>is known</div>
              </button>
              <button class="type-btn" data-mode="type3">
                <div class="type-main">Type 3</div>
                <div class="type-sub">Difference between<br>two shares</div>
              </button>
              <button class="type-btn" data-mode="mixed">
                <div class="type-main">Mixed</div>
                <div class="type-sub">Automatically mixes<br>Types 1–3</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Main column: all content -->
        <div class="main-column">

          <div id="quizMeta" class="quiz-meta" aria-live="polite" hidden></div>

          <div id="question" class="question" aria-live="polite"></div>

          <!-- Progress row -->
          <div class="question-tools">
            <div class="progress">
              <div class="step" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Model</div>
              </div>
              <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Divide</div>
              </div>
              <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Answer</div>
              </div>
            </div>
          </div>

          <div id="quizPrompt" class="quiz-prompt" hidden></div>

          <div class="controls">
            <button id="backBtn" class="btn back-btn" aria-label="Step back" title="Step back one stage" disabled>&larr;</button>
            <button id="mainActionBtn" class="btn primary">Show model</button>
            <button id="newProblemBtn" class="btn">New problem</button>
            <button id="resetBtn" class="btn">Reset</button>
          </div>

          <div id="modelArea" class="model-area">
            <div id="bars" class="bars" hidden></div>
          </div>

          <div id="answerArea" class="answer-area" aria-live="polite"></div>
          <div id="quizError" class="quiz-error" aria-live="polite"></div>

          <!-- Quiz-only controls -->
          <div id="quizControls" class="quiz-controls" hidden>
            <button id="quizCheckBtn" class="btn primary">Check answer</button>
            <button id="quizPrevBtn" class="btn">Previous question</button>
            <button id="quizNextBtn" class="btn">Next question</button>
          </div>

          <div class="footer-note">
            Each box is <em>one equal part</em>. The number inside each box is the value of one part.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz result overlay -->
  <div id="quizOverlay" class="quiz-overlay" role="dialog" aria-modal="true" aria-labelledby="quizOverlayTitle" aria-describedby="quizOverlayMsg">
    <div class="quiz-overlay-card">
      <div id="quizOverlayTitle" class="quiz-overlay-title">Well done!</div>
      <div id="quizOverlayScore" class="quiz-overlay-score"></div>
      <div id="quizOverlayMsg" class="quiz-overlay-msg"></div>
      <button id="quizOverlayClose" class="btn primary">Close</button>
    </div>
  </div>

<script>
(function(){
  // Sounds --------------------------------------------------------------
   // Sounds --------------------------------------------------------------
  // Sound removed: keep function so the rest of the program is unchanged.
  function playSound(name){
    // no-op
  }


  // Unit formats --------------------------------------------------------
  const UNIT_FORMATS = {
    money:      {prefix:'$', suffix:'', label:'amount'},
    grams:      {prefix:'', suffix:' g', label:'grams'},
    metres:     {prefix:'', suffix:' m', label:'metres'},
    centimetres:{prefix:'', suffix:' cm', label:'centimetres'},
    minutes:    {prefix:'', suffix:' minutes', label:'minutes'},
    litres:     {prefix:'', suffix:' L', label:'litres'}
  };
  const TYPE1_UNIT_KEYS = ['money','grams','metres','centimetres','minutes','litres'];
  let currentUnitKey = 'money';

  function fmt(n){
    const u = UNIT_FORMATS[currentUnitKey] || UNIT_FORMATS.money;
    return u.prefix + n.toLocaleString('en-AU') + u.suffix;
  }

  // State ---------------------------------------------------------------
  let mode = "type1";
  let activeType = "type1";

  let amount = 140;
  let leftParts = 3;
  let rightParts = 4;
  let valuePerPart = 20;
  let leftTotal = 0;
  let rightTotal = 0;

  let leftName = "Jane";
  let rightName = "Bob";
  let contextNoun = "rent";
  let contextVerb = "pays";

  let knownSide = null;
  let knownAmount = 0;

  let diffParts = 0;
  let diffAmount = 0;
  let biggerSide = null;
  let smallerSide = null;
  let isMoreForm = true;

  let mainStage = "showModel";
  let practiceMode = false;

  // Quiz state
  let quizMode = false;
  let quizQuestions = [];
  let quizIndex = 0;
  let quizScore = 0;
  let quizFromMode = "type1";

  const questionEl      = document.getElementById('question');
  const mainActionBtn   = document.getElementById('mainActionBtn');
  const newProblemBtn   = document.getElementById('newProblemBtn');
  const resetBtn        = document.getElementById('resetBtn');
  const barsEl          = document.getElementById('bars');
  const answerArea      = document.getElementById('answerArea');
  const modeBanner      = document.getElementById('modeBanner');
  const backBtn         = document.getElementById('backBtn');
  const stepEls         = document.querySelectorAll('.step');
  const typeButtons     = document.querySelectorAll('.type-btn');

  const quizMetaEl      = document.getElementById('quizMeta');
  const quizPromptEl    = document.getElementById('quizPrompt');
  const quizErrorEl     = document.getElementById('quizError');
  const quizControlsEl  = document.getElementById('quizControls');
  const quizCheckBtn    = document.getElementById('quizCheckBtn');
  const quizPrevBtn     = document.getElementById('quizPrevBtn');
  const quizNextBtn     = document.getElementById('quizNextBtn');

  const quizOverlay     = document.getElementById('quizOverlay');
  const quizOverlayTitle= document.getElementById('quizOverlayTitle');
  const quizOverlayScore= document.getElementById('quizOverlayScore');
  const quizOverlayMsg  = document.getElementById('quizOverlayMsg');
  const quizOverlayClose= document.getElementById('quizOverlayClose');

  const sideDemoBtn     = document.getElementById('sideDemoBtn');
  const sidePracticeBtn = document.getElementById('sidePracticeBtn');
  const sideQuizBtn     = document.getElementById('sideQuizBtn');

  const fullscreenBtn   = document.getElementById('fullscreenBtn');
  const cardRoot        = document.getElementById('cardRoot');
  let isFullscreen      = false;

  const namePairs = [
    ["Jane","Bob"],
    ["Amira","Liam"],
    ["Mia","Noah"],
    ["Zoe","Ethan"],
    ["Ava","Lucas"],
    ["Chloe","Max"],
    ["Sofia","Jack"],
    ["Isla","Henry"]
  ];

  // Contexts now include a unit key so questions vary beyond money.
  const type2Contexts = [
    {noun:"rent",             verb:"pays",     unit:"money"},
    {noun:"grocery bill",     verb:"pays",     unit:"money"},
    {noun:"phone bill",       verb:"pays",     unit:"money"},
    {noun:"travel costs",     verb:"pays",     unit:"money"},
    {noun:"pocket money",     verb:"gets",     unit:"money"},
    {noun:"charity donation", verb:"donates",  unit:"money"},
    {noun:"trail mix",        verb:"gets",     unit:"grams"},
    {noun:"flour",            verb:"gets",     unit:"grams"},
    {noun:"rope",             verb:"gets",     unit:"metres"},
    {noun:"ribbon",           verb:"gets",     unit:"centimetres"},
    {noun:"water",            verb:"gets",     unit:"litres"},
    {noun:"screen time",      verb:"gets",     unit:"minutes"}
  ];

  const type3Contexts = [
    {noun:"rent",            verb:"pays",  unit:"money"},
    {noun:"phone bill",      verb:"pays",  unit:"money"},
    {noun:"electricity bill",verb:"pays",  unit:"money"},
    {noun:"holiday costs",   verb:"pays",  unit:"money"},
    {noun:"pet costs",       verb:"pays",  unit:"money"},
    {noun:"sports fees",     verb:"pays",  unit:"money"},
    {noun:"trail mix",       verb:"gets",  unit:"grams"},
    {noun:"rope",            verb:"gets",  unit:"metres"},
    {noun:"screen time",     verb:"gets",  unit:"minutes"},
    {noun:"water",           verb:"gets",  unit:"litres"}
  ];

  function randInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  function choice(arr){
    return arr[randInt(0, arr.length - 1)];
  }

  function setModeBanner(text, variant){
    modeBanner.textContent = text;
    modeBanner.classList.remove('demo','practice','quiz');
    if(variant) modeBanner.classList.add(variant);
  }

  function updateProgress(currentStep){
    stepEls.forEach(step=>{
      const stepNum = Number(step.dataset.step);
      step.classList.remove('active','completed');
      if(stepNum < currentStep){
        step.classList.add('completed');
      }else if(stepNum === currentStep){
        step.classList.add('active');
      }
    });
  }

  function updateBackButton(){
    if(practiceMode || quizMode){
      backBtn.disabled = true;
    } else {
      backBtn.disabled = (mainStage === "showModel");
    }
  }

  function updateModeButtons(){
    sideDemoBtn.classList.remove('active');
    sidePracticeBtn.classList.remove('active');
    sideQuizBtn.classList.remove('active');

    if(quizMode){
      sideQuizBtn.classList.add('active');
    } else if(practiceMode){
      sidePracticeBtn.classList.add('active');
    } else {
      sideDemoBtn.classList.add('active');
    }
  }

  function setMainStage(stage){
    mainStage = stage;
    if(!practiceMode){
      if(stage === "showModel"){
        mainActionBtn.textContent = "Show model";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(1);
      } else if(stage === "divide"){
        mainActionBtn.textContent = "Divide";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(2);
      } else if(stage === "showAnswer"){
        mainActionBtn.textContent = "Show answer";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(3);
      } else if(stage === "done"){
        mainActionBtn.textContent = "Show answer";
        mainActionBtn.disabled = true;
        mainActionBtn.classList.remove("primary");
        updateProgress(3);
      }
    } else {
      if(stage === "showModel"){
        mainActionBtn.textContent = "Show model";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(1);
      } else if(stage === "enterPerPart"){
        mainActionBtn.textContent = "Enter";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(2);
      } else if(stage === "enterTotals"){
        mainActionBtn.textContent = "Enter answer";
        mainActionBtn.disabled = false;
        mainActionBtn.classList.add("primary");
        updateProgress(3);
      } else if(stage === "done"){
        mainActionBtn.textContent = "Enter answer";
        mainActionBtn.disabled = true;
        mainActionBtn.classList.remove("primary");
        updateProgress(3);
      }
    }
    updateBackButton();
  }

  // Problem generators --------------------------------------------------
  function generateType1(){
    currentUnitKey = choice(TYPE1_UNIT_KEYS);

    do{
      leftParts  = randInt(1,8);
      rightParts = randInt(1,8);
      valuePerPart = randInt(2,20);
      leftTotal  = leftParts  * valuePerPart;
      rightTotal = rightParts * valuePerPart;
      amount     = leftTotal + rightTotal;
    } while(amount < 40 || amount > 400);

    const ratioHTML =
      `<span class="question-ratio"><span class="ratio-left">${leftParts}</span>` +
      ` : <span class="ratio-right">${rightParts}</span></span>`;

    questionEl.innerHTML =
      `Share <span class="question-amount">${fmt(amount)}</span> in the ratio ${ratioHTML}.`;
  }

  function generateType2(){
    [leftName, rightName] = choice(namePairs);
    const ctx = choice(type2Contexts);
    contextNoun = ctx.noun;
    contextVerb = ctx.verb;
    currentUnitKey = ctx.unit || 'money';

    do{
      leftParts  = randInt(1,8);
      rightParts = randInt(1,8);
      valuePerPart = randInt(2,20);
      leftTotal  = leftParts  * valuePerPart;
      rightTotal = rightParts * valuePerPart;
      amount     = leftTotal + rightTotal;
    } while(amount < 40 || amount > 400);

    knownSide = Math.random() < 0.5 ? "left" : "right";
    knownAmount = (knownSide === "left") ? leftTotal : rightTotal;
    const knownName = (knownSide === "left") ? leftName : rightName;

    const ratioHTML =
      `<span class="question-ratio"><span class="ratio-left">${leftParts}</span>` +
      ` : <span class="ratio-right">${rightParts}</span></span>`;

    questionEl.innerHTML =
      `${leftName} and ${rightName} share ${contextNoun} in the ratio ${ratioHTML} ` +
      `and ${knownName} ${contextVerb} ` +
      `<span class="question-amount">${fmt(knownAmount)}</span>.`;
  }

  function generateType3(){
    [leftName, rightName] = choice(namePairs);
    const ctx = choice(type3Contexts);
    contextNoun = ctx.noun;
    contextVerb = ctx.verb;
    currentUnitKey = ctx.unit || 'money';

    do{
      do{
        leftParts  = randInt(1,8);
        rightParts = randInt(1,8);
      }while(leftParts === rightParts);

      valuePerPart = randInt(2,20);
      leftTotal  = leftParts  * valuePerPart;
      rightTotal = rightParts * valuePerPart;
      amount     = leftTotal + rightTotal;
    } while(amount < 40 || amount > 400);

    diffParts = Math.abs(leftParts - rightParts);
    diffAmount = diffParts * valuePerPart;

    if(leftTotal > rightTotal){
      biggerSide = "left";
      smallerSide = "right";
    } else {
      biggerSide = "right";
      smallerSide = "left";
    }

    const biggerName  = (biggerSide === "left")  ? leftName  : rightName;
    const smallerName = (smallerSide === "left") ? leftName  : rightName;

    const ratioHTML =
      `<span class="question-ratio"><span class="ratio-left">${leftParts}</span>` +
      ` : <span class="ratio-right">${rightParts}</span></span>`;

    isMoreForm = Math.random() < 0.5;

    let sentence;
    if(isMoreForm){
      sentence =
        `${biggerName} ${contextVerb} <span class="question-amount">${fmt(diffAmount)}</span> more than ${smallerName}`;
    } else {
      sentence =
        `${smallerName} ${contextVerb} <span class="question-amount">${fmt(diffAmount)}</span> less than ${biggerName}`;
    }

    questionEl.innerHTML =
      `${leftName} and ${rightName} share ${contextNoun} in the ratio ${ratioHTML} ` +
      `and ${sentence}.`;
  }

  function generateProblem(){
    if(mode === "mixed"){
      const t = randInt(1,3);
      activeType = "type" + t;
    } else {
      activeType = mode;
    }

    if(activeType === "type1") generateType1();
    else if(activeType === "type2") generateType2();
    else generateType3();

    resetCurrentProblemView();
  }

  // Rendering / reset ---------------------------------------------------
  function resetCurrentProblemView(){
    barsEl.classList.remove('show');
    barsEl.innerHTML = '';
    barsEl.hidden = true;
    answerArea.innerHTML = '';
    quizErrorEl.textContent = '';
    setMainStage("showModel");
  }

  function buildModel(){
    barsEl.classList.remove('show');
    barsEl.innerHTML = '';

    const maxParts = Math.max(leftParts, rightParts);
    const biggerParts  = maxParts;

    const topRow = document.createElement('div');
    topRow.className = 'bar-row top-row';
    const leftIsSmaller = (activeType === "type3" && smallerSide === "left");

    for(let i=0;i<maxParts;i++){
      const seg = document.createElement('div');
      seg.className = 'segment';

      if(activeType === "type3" && leftIsSmaller){
        if(i < leftParts){
          seg.dataset.active = 'true';
          seg.dataset.owner = 'left';
          seg.title = `${leftName}'s part`;
        } else if(i < biggerParts){
          seg.classList.add('gap-cell');
          seg.dataset.activeGap = 'true';
          seg.dataset.owner = 'gap';
          seg.title = "Difference in parts";
        } else {
          seg.classList.add('filler');
          seg.dataset.owner = 'left-gap';
        }
      } else {
        if(i < leftParts){
          seg.dataset.active = 'true';
          seg.dataset.owner = 'left';
          seg.title = (activeType === "type2" || activeType === "type3")
            ? `${leftName}'s part`
            : "1 part of the ratio (left side)";
        } else {
          seg.classList.add('filler');
          seg.dataset.owner = 'left-gap';
        }
      }
      topRow.appendChild(seg);
    }

    const bottomRow = document.createElement('div');
    bottomRow.className = 'bar-row bottom-row';
    const rightIsSmaller = (activeType === "type3" && smallerSide === "right");

    for(let i=0;i<maxParts;i++){
      const seg = document.createElement('div');
      seg.className = 'segment';

      if(activeType === "type3" && rightIsSmaller){
        if(i < rightParts){
          seg.dataset.active = 'true';
          seg.dataset.owner = 'right';
          seg.title = `${rightName}'s part`;
        } else if(i < biggerParts){
          seg.classList.add('gap-cell');
          seg.dataset.activeGap = 'true';
          seg.dataset.owner = 'gap';
          seg.title = "Difference in parts";
        } else {
          seg.classList.add('filler');
        }
      } else {
        if(i < rightParts){
          seg.dataset.active = 'true';
          seg.dataset.owner = 'right';
          seg.title = (activeType === "type2" || activeType === "type3")
            ? `${rightName}'s part`
            : "1 part of the ratio (right side)";
        } else {
          seg.classList.add('filler');
        }
      }
      bottomRow.appendChild(seg);
    }

    barsEl.appendChild(topRow);
    barsEl.appendChild(bottomRow);

    barsEl.hidden = false;
    requestAnimationFrame(()=> {
      barsEl.classList.add('show');
    });
  }

  function divideIntoParts(){
    const perPart = valuePerPart;
    const segments = Array.from(barsEl.querySelectorAll('.segment'));
    let activeIndex = 0;

    if(activeType === "type1"){
      segments.forEach(seg=>{
        if(seg.dataset.active === 'true' || seg.dataset.activeGap === 'true'){
          const delay = activeIndex * 60;
          setTimeout(()=>{
            seg.textContent = perPart;
            seg.classList.add('pop');
            seg.title = `1 part = ${fmt(perPart)}`;
            seg.addEventListener('animationend', ()=> seg.classList.remove('pop'), {once:true});
          }, delay);
          activeIndex++;
        } else if(!seg.classList.contains('filler')){
          seg.textContent = '';
        }
      });
    } else if(activeType === "type2"){
      segments.forEach(seg=>{
        const owner = seg.dataset.owner;
        if(seg.dataset.active === 'true' && owner === knownSide){
          const delay = activeIndex * 60;
          setTimeout(()=>{
            seg.textContent = perPart;
            seg.classList.add('pop');
            seg.title = `1 part = ${fmt(perPart)}`;
            seg.addEventListener('animationend', ()=> seg.classList.remove('pop'), {once:true});
          }, delay);
          activeIndex++;
        } else if(!seg.classList.contains('filler')){
          seg.textContent = '';
        }
      });
    } else if(activeType === "type3"){
      segments.forEach(seg=>{
        if(seg.dataset.activeGap === 'true'){
          const delay = activeIndex * 60;
          setTimeout(()=>{
            seg.textContent = perPart;
            seg.classList.add('pop');
            seg.title = `Difference part = ${fmt(perPart)}`;
            seg.addEventListener('animationend', ()=> seg.classList.remove('pop'), {once:true});
          }, delay);
          activeIndex++;
        } else if(!seg.classList.contains('filler')){
          seg.textContent = '';
        }
      });
    }

    if(navigator.vibrate){
      navigator.vibrate(40);
    }
  }

  function showAnswerDemo(){
    const perPart = valuePerPart;
    const segments = Array.from(barsEl.querySelectorAll('.segment'));

    if(activeType === "type2"){
      const unknownSide = (knownSide === "left") ? "right" : "left";
      segments.forEach(seg=>{
        if(seg.dataset.active === 'true' && seg.dataset.owner === unknownSide){
          if(!seg.textContent){
            seg.textContent = perPart;
            seg.classList.add('pop');
            seg.title = `1 part = ${fmt(perPart)}`;
            seg.addEventListener('animationend', ()=> seg.classList.remove('pop'), {once:true});
          }
        }
      });
    } else if(activeType === "type3"){
      segments.forEach(seg=>{
        if(seg.dataset.active === 'true'){
          if(!seg.textContent){
            seg.textContent = perPart;
            seg.classList.add('pop');
            seg.title = `1 part = ${fmt(perPart)}`;
            seg.addEventListener('animationend', ()=> seg.classList.remove('pop'), {once:true});
          }
        }
      });
    }

    let html;
    if(activeType === "type1"){
      html =
        `<div class="answer-text">Answer is ` +
        `<span class="answer-left">${fmt(leftTotal)}</span>` +
        ` : ` +
        `<span class="answer-right">${fmt(rightTotal)}</span>` +
        `</div>`;
    } else if(activeType === "type2"){
      const unknownSide = (knownSide === "left") ? "right" : "left";
      const unknownName = (unknownSide === "left") ? leftName : rightName;
      const unknownAmount = (unknownSide === "left") ? leftTotal : rightTotal;
      const total = leftTotal + rightTotal;

      html =
        `<div class="answer-text">${unknownName} ${contextVerb} ` +
        `<span class="answer-left">${fmt(unknownAmount)}</span>` +
        ` and the total is <span class="answer-right">${fmt(total)}</span>.</div>`;
    } else {
      const total = leftTotal + rightTotal;
      html =
        `<div class="answer-text">${leftName} ${contextVerb} ` +
        `<span class="answer-left">${fmt(leftTotal)}</span>, ` +
        `${rightName} ${contextVerb} ` +
        `<span class="answer-right">${fmt(rightTotal)}</span>` +
        ` and the total is ${fmt(total)}.</div>`;
    }

    answerArea.innerHTML = html;

    answerArea.classList.remove('answer-glow');
    void answerArea.offsetWidth;
    answerArea.classList.add('answer-glow');
    setTimeout(()=> answerArea.classList.remove('answer-glow'), 1200);
  }

  // Practice helpers ----------------------------------------------------
  function makeInputInSegment(seg){
    seg.textContent = "";
    const input = document.createElement('input');
    input.type = "number";
    input.inputMode = "numeric";
    input.className = "part-input";
    seg.appendChild(input);
    return input;
  }

  function getPerPartTargets(){
    const segments = Array.from(barsEl.querySelectorAll('.segment'));
    if(activeType === "type1"){
      return segments.filter(seg => seg.dataset.active === 'true' || seg.dataset.activeGap === 'true');
    }
    if(activeType === "type2"){
      return segments.filter(seg => seg.dataset.active === 'true' && seg.dataset.owner === knownSide);
    }
    return segments.filter(seg => seg.dataset.activeGap === 'true');
  }

  function clearSegmentMarks(){
    barsEl.querySelectorAll('.segment').forEach(seg=>{
      seg.classList.remove('practice-dim','practice-target','correct','incorrect','touched');
    });
  }

  function onPerPartInputChange(e){
    const value = e.target.value;

    const inputs = barsEl.querySelectorAll('.part-input');
    inputs.forEach(inp => {
      if(inp !== e.target){
        inp.value = value;
      }
    });

    const dimSegs = barsEl.querySelectorAll('.segment.practice-dim');
    dimSegs.forEach(seg => {
      seg.textContent = value ? value : "";
    });
  }

  function setupPracticePerPartInputs(){
    const targets = getPerPartTargets();
    const targetSet = new Set(targets);
    const allSegs = Array.from(barsEl.querySelectorAll('.segment'));

    allSegs.forEach(seg=>{
      seg.classList.remove('practice-dim','practice-target','correct','incorrect');
      seg.textContent = "";

      if(targetSet.has(seg)){
        seg.classList.add('practice-target');
        const input = makeInputInSegment(seg);
        input.addEventListener('input', onPerPartInputChange);
      } else if((seg.dataset.active === 'true' || seg.dataset.activeGap === 'true') && !seg.classList.contains('filler')){
        seg.classList.add('practice-dim');
        seg.textContent = "";
      }
    });

    answerArea.innerHTML =
      `<div class="answer-text" style="font-size:18px;">
        Practice: enter the value of any highlighted box, then press <strong>Enter</strong>.
      </div>`;
  }

  function checkPracticePerPart(){
    const perPart = valuePerPart;
    const targets = getPerPartTargets();
    if(targets.length === 0) return;

    let allCorrect = true;
    targets.forEach(seg=>{
      const input = seg.querySelector('input');
      const v = Number(input.value);
      if(v === perPart){
        seg.classList.add('correct');
        seg.classList.remove('incorrect');
      } else {
        seg.classList.add('incorrect');
        seg.classList.remove('correct');
        allCorrect = false;
      }
    });

    if(allCorrect){
      playSound('correct');

      const segments = Array.from(barsEl.querySelectorAll('.segment'));
      segments.forEach(seg=>{
        const input = seg.querySelector('input');
        if(input){
          seg.removeChild(input);
        }
        if(seg.dataset.active === 'true' || seg.dataset.activeGap === 'true'){
          seg.textContent = perPart;
        } else if(!seg.classList.contains('filler')){
          seg.textContent = '';
        }
        seg.classList.remove('practice-dim','practice-target','correct','incorrect');
      });

      answerArea.innerHTML =
        `<div class="answer-text" style="font-size:18px;">
           Great! Now complete the answer boxes below, then press <strong>Enter answer</strong>.
         </div>`;
      setMainStage("enterTotals");
      setupPracticeTotalsInputs();
    } else {
      playSound('error');
      answerArea.innerHTML =
        `<div class="answer-text" style="font-size:18px; color:var(--error);">
           Check your part values and try again.
         </div>`;
    }
  }

  function setupPracticeTotalsInputs(){
    let html = "";

    if(activeType === "type1"){
      html =
        `<div style="font-size:18px;">
          Enter the two amounts in the ratio
          <span class="ratio-left">${leftParts}</span> :
          <span class="ratio-right">${rightParts}</span>.<br/><br/>
          Left: <input id="ansLeft" class="answer-input" type="number" />
          Right: <input id="ansRight" class="answer-input" type="number" />
        </div>`;
    } else if(activeType === "type2"){
      const unknownSide = (knownSide === "left") ? "right" : "left";
      const unknownName = (unknownSide === "left") ? leftName : rightName;
      html =
        `<div style="font-size:18px;">
          Enter <strong>${unknownName}</strong>'s share and the total amount.<br/><br/>
          ${unknownName}: <input id="ansUnknown" class="answer-input" type="number" />
          Total: <input id="ansTotal" class="answer-input" type="number" />
        </div>`;
    } else {
      html =
        `<div style="font-size:18px;">
          Enter how much each person ${contextVerb} and the total amount.<br/><br/>
          ${leftName}: <input id="ansLeft" class="answer-input" type="number" /><br/><br/>
          ${rightName}: <input id="ansRight" class="answer-input" type="number" /><br/><br/>
          Total: <input id="ansTotal" class="answer-input" type="number" />
        </div>`;
    }
    answerArea.innerHTML = html;
  }

  function fillAllPartsForVisual(){
    const perPart = valuePerPart;
    barsEl.querySelectorAll('.segment').forEach(seg=>{
      if(seg.dataset.active === 'true' || seg.dataset.activeGap === 'true'){
        seg.textContent = perPart;
      }
    });
  }

  function checkPracticeTotals(){
    const total = leftTotal + rightTotal;
    let ok = true;

    function mark(input, correctVal){
      const v = Number(input.value);
      if(v === correctVal){
        input.classList.add('correct');
        input.classList.remove('incorrect');
      } else {
        input.classList.add('incorrect');
        input.classList.remove('correct');
        ok = false;
      }
    }

    if(activeType === "type1"){
      const leftInput = document.getElementById('ansLeft');
      const rightInput = document.getElementById('ansRight');
      if(!leftInput || !rightInput) return;
      mark(leftInput, leftTotal);
      mark(rightInput, rightTotal);
    } else if(activeType === "type2"){
      const unknownSide = (knownSide === "left") ? "right" : "left";
      const unknownAmount = (unknownSide === "left") ? leftTotal : rightTotal;
      const unknownInput = document.getElementById('ansUnknown');
      const totalInput   = document.getElementById('ansTotal');
      if(!unknownInput || !totalInput) return;
      mark(unknownInput, unknownAmount);
      mark(totalInput, total);
    } else {
      const leftInput  = document.getElementById('ansLeft');
      const rightInput = document.getElementById('ansRight');
      const totalInput = document.getElementById('ansTotal');
      if(!leftInput || !rightInput || !totalInput) return;
      mark(leftInput, leftTotal);
      mark(rightInput, rightTotal);
      mark(totalInput, total);
    }

    if(ok){
      playSound('correct');
      fillAllPartsForVisual();

      let html;
      if(activeType === "type1"){
        html =
          `<div class="answer-text">Answer is ` +
          `<span class="answer-left">${fmt(leftTotal)}</span>` +
          ` : ` +
          `<span class="answer-right">${fmt(rightTotal)}</span>` +
          ` &mdash; well done!</div>`;
      } else if(activeType === "type2"){
        const unknownSide = (knownSide === "left") ? "right" : "left";
        const unknownName = (unknownSide === "left") ? leftName : rightName;
        const unknownAmount = (unknownSide === "left") ? leftTotal : rightTotal;
        const totalVal = leftTotal + rightTotal;
        html =
          `<div class="answer-text">${unknownName} ${contextVerb} ` +
          `<span class="answer-left">${fmt(unknownAmount)}</span> and the total is ` +
          `<span class="answer-right">${fmt(totalVal)}</span>. Nice work!</div>`;
      } else {
        const tot = leftTotal + rightTotal;
        html =
          `<div class="answer-text">${leftName} ${contextVerb} ` +
          `<span class="answer-left">${fmt(leftTotal)}</span>, ` +
          `${rightName} ${contextVerb} ` +
          `<span class="answer-right">${fmt(rightTotal)}</span>` +
          ` and the total is ${fmt(tot)}. Well done!</div>`;
      }
      answerArea.innerHTML = html;

      answerArea.classList.remove('answer-glow');
      void answerArea.offsetWidth;
      answerArea.classList.add('answer-glow');
      setTimeout(()=> answerArea.classList.remove('answer-glow'), 1200);

      setMainStage("done");
    } else {
      playSound('error');
      const msg =
        `<div class="answer-text" style="font-size:18px; color:var(--error);">
           Some of the answers are not quite right yet. Check your totals and try again.
         </div>`;
      answerArea.innerHTML = msg;
    }
  }

  // Quiz helpers --------------------------------------------------------
  function getQuizTypeFromMode(){
    if(quizFromMode === "mixed"){
      const t = randInt(1,3);
      return "type" + t;
    }
    return quizFromMode;
  }

  function buildQuizQuestionObject(){
    const qType = getQuizTypeFromMode();
    activeType = qType;

    if(qType === "type1") generateType1();
    else if(qType === "type2") generateType2();
    else generateType3();

    const total = leftTotal + rightTotal;

    let layout, prompt, correct = {}, which;

    if(qType === "type1"){
      layout = "two";
      prompt = "Enter the two amounts in the ratio.";
      correct.left = leftTotal;
      correct.right = rightTotal;
    } else if(qType === "type2"){
      which = Math.random() < 0.5 ? "total" : "other";
      if(which === "total"){
        layout = "total";
        prompt = "What is the total amount?";
        correct.total = total;
      } else {
        const unknownSide = (knownSide === "left") ? "right" : "left";
        const unknownName = (unknownSide === "left") ? leftName : rightName;
        layout = "one";
        prompt = `How much does ${unknownName} ${contextVerb}?`;
        correct.one = (unknownSide === "left") ? leftTotal : rightTotal;
      }
    } else {
      const pick = ["total","left","right"][randInt(0,2)];
      if(pick === "total"){
        layout = "total";
        prompt = "What is the total amount?";
        correct.total = total;
      } else if(pick === "left"){
        layout = "one";
        prompt = `How much does ${leftName} ${contextVerb}?`;
        correct.one = leftTotal;
      } else {
        layout = "one";
        prompt = `How much does ${rightName} ${contextVerb}?`;
        correct.one = rightTotal;
      }
    }

    return {
      type:qType,
      questionHTML: questionEl.innerHTML,
      prompt,
      layout,
      correct,
      user:{},
      scored:false,
      wasCorrect:false
    };
  }

  function renderQuizQuestion(){
    const q = quizQuestions[quizIndex];

    questionEl.innerHTML = q.questionHTML;
    quizPromptEl.textContent = q.prompt;
    quizPromptEl.hidden = false;

    quizErrorEl.textContent = "";
    quizMetaEl.hidden = false;
    quizMetaEl.textContent = `Question ${quizIndex+1} of 15 · Score: ${quizScore}`;

    let html = "";

    if(q.layout === "two"){
      html =
        `<div style="font-size:22px; margin-top:18px;">
           <label style="margin-right:12px;">
             Left:
             <input id="quizLeft" class="answer-input" type="number" />
           </label>
           <label style="margin-left:12px;">
             Right:
             <input id="quizRight" class="answer-input" type="number" />
           </label>
         </div>`;
    } else if(q.layout === "total"){
      html =
        `<div style="font-size:22px; margin-top:18px;">
           Total amount:
           <input id="quizTotal" class="answer-input" type="number" />
         </div>`;
    } else {
      html =
        `<div style="font-size:22px; margin-top:18px;">
           Amount:
           <input id="quizOne" class="answer-input" type="number" />
         </div>`;
    }

    answerArea.innerHTML = html;

    quizPrevBtn.disabled = (quizIndex === 0);
    quizNextBtn.disabled = (quizIndex >= quizQuestions.length - 1);

    const firstInput = answerArea.querySelector('input');
    if(firstInput) firstInput.focus();
  }

  function enterQuizMode(){
    quizMode = true;
    document.body.classList.add('quiz-active');
    setModeBanner("Quiz Mode Activated","quiz");
    quizFromMode = mode;
    quizQuestions = [];
    quizIndex = 0;
    quizScore = 0;

    quizControlsEl.hidden = false;
    quizPromptEl.hidden = false;

    resetCurrentProblemView();

    const firstQ = buildQuizQuestionObject();
    quizQuestions.push(firstQ);
    renderQuizQuestion();
    updateModeButtons();
  }

  function exitQuizMode(){
    quizMode = false;
    document.body.classList.remove('quiz-active');
    if(practiceMode){
      setModeBanner("Practice Mode Activated","practice");
    }else{
      setModeBanner("Demo Mode Activated","demo");
    }
    quizMetaEl.hidden = true;
    quizPromptEl.hidden = true;
    quizControlsEl.hidden = true;
    quizErrorEl.textContent = "";
    answerArea.innerHTML = "";
    generateProblem();
    updateModeButtons();
  }

  function scoreMessage(score){
    if (score === 15) {
      return "Perfect score – you really understand these problems.";
    } else if (score >= 11) {
      return "Awesome work – just a couple to polish.";
    } else if (score >= 6) {
      return "Nice effort – keep practising these questions.";
    } else {
      return "This set was challenging. Let’s practise a bit more and try again.";
    }
  }

function showQuizOverlay(){
  // If we're in full screen, exit so the certificate is visible on the page
  if (isFullscreen) {
    exitFullscreen();
  }

  let title;
  if (quizScore === 15) {
    title = "Outstanding!";
  } else if (quizScore >= 11) {
    title = "Great job!";
  } else if (quizScore >= 6) {
    title = "Nice effort!";
  } else {
    title = "Keep going!";
  }

  quizOverlayTitle.textContent = title;
  quizOverlayScore.textContent = `Score: ${quizScore} / 15 (${mode.toUpperCase()})`;
  quizOverlayMsg.textContent = scoreMessage(quizScore);
  quizOverlay.classList.add('show');
}


  function closeQuizOverlay(){
    quizOverlay.classList.remove('show');
  }

  function checkQuizAnswer(){
    const q = quizQuestions[quizIndex];
    if(!q) return;

    let correct = true;

    function val(id){
      const el = document.getElementById(id);
      return el ? Number(el.value) : NaN;
    }

    if(q.layout === "two"){
      const leftVal  = val('quizLeft');
      const rightVal = val('quizRight');
      q.user.left = leftVal;
      q.user.right = rightVal;

      const leftInput  = document.getElementById('quizLeft');
      const rightInput = document.getElementById('quizRight');

      if(leftVal === q.correct.left){
        leftInput.classList.add('correct');
        leftInput.classList.remove('incorrect');
      } else {
        leftInput.classList.add('incorrect');
        leftInput.classList.remove('correct');
        correct = false;
      }
      if(rightVal === q.correct.right){
        rightInput.classList.add('correct');
        rightInput.classList.remove('incorrect');
      } else {
        rightInput.classList.add('incorrect');
        rightInput.classList.remove('correct');
        correct = false;
      }
    } else if(q.layout === "total"){
      const totalVal = val('quizTotal');
      q.user.total = totalVal;
      const totalInput = document.getElementById('quizTotal');

      if(totalVal === q.correct.total){
        totalInput.classList.add('correct');
        totalInput.classList.remove('incorrect');
      } else {
        totalInput.classList.add('incorrect');
        totalInput.classList.remove('correct');
        correct = false;
      }
    } else {
      const oneVal = val('quizOne');
      q.user.one = oneVal;
      const oneInput = document.getElementById('quizOne');

      if(oneVal === q.correct.one){
        oneInput.classList.add('correct');
        oneInput.classList.remove('incorrect');
      } else {
        oneInput.classList.add('incorrect');
        oneInput.classList.remove('correct');
        correct = false;
      }
    }

    quizErrorEl.textContent = "";
    if(correct){
      playSound('correct');
      if(!q.scored){
        q.scored = true;
        q.wasCorrect = true;
        quizScore++;
      }
    } else {
      playSound('error');
      if(!q.scored){
        q.scored = true;
        q.wasCorrect = false;
      }
      quizErrorEl.textContent = "Not quite right yet – check your working and try again.";
    }

    quizMetaEl.textContent = `Question ${quizIndex+1} of 15 · Score: ${quizScore}`;

    setTimeout(()=>{
      if(quizIndex === 14){
        showQuizOverlay();
      } else {
        gotoQuizNext();
      }
    }, 900);
  }

  function gotoQuizNext(){
    if(quizIndex >= 14) return;

    quizIndex++;
    if(quizIndex < quizQuestions.length){
      renderQuizQuestion();
    } else {
      const q = buildQuizQuestionObject();
      quizQuestions.push(q);
      renderQuizQuestion();
    }
  }

  function gotoQuizPrev(){
    if(quizIndex === 0) return;
    quizIndex--;
    renderQuizQuestion();
  }

  // Event wiring --------------------------------------------------------
  typeButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      playSound('type');
      typeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      mode = btn.dataset.mode;
      if(!quizMode){
        generateProblem();
      } else {
        // In quiz mode: restart quiz for new type
        quizFromMode = mode;
        quizQuestions = [];
        quizIndex = 0;
        quizScore = 0;
        const firstQ = buildQuizQuestionObject();
        quizQuestions.push(firstQ);
        renderQuizQuestion();
      }
    });
  });

  mainActionBtn.addEventListener('click', ()=>{
    if(!practiceMode &&
       (mainStage === "showModel" || mainStage === "divide" || mainStage === "showAnswer")){
      playSound('select');
    }

    if(!practiceMode){
      if(mainStage === "showModel"){
        buildModel();
        setMainStage("divide");
      } else if(mainStage === "divide"){
        divideIntoParts();
        setMainStage("showAnswer");
      } else if(mainStage === "showAnswer"){
        showAnswerDemo();
        setMainStage("done");
      }
    } else {
      if(mainStage === "showModel"){
        buildModel();
        clearSegmentMarks();
        setupPracticePerPartInputs();
        setMainStage("enterPerPart");
      } else if(mainStage === "enterPerPart"){
        checkPracticePerPart();
      } else if(mainStage === "enterTotals"){
        checkPracticeTotals();
      }
    }
  });

  backBtn.addEventListener('click', ()=>{
    if(practiceMode || quizMode) return;
    playSound('select');

    if(mainStage === "divide"){
      resetCurrentProblemView();
    } else if(mainStage === "showAnswer"){
      buildModel();
      answerArea.innerHTML = '';
      setMainStage("divide");
    } else if(mainStage === "done"){
      answerArea.innerHTML = '';
      setMainStage("showAnswer");
    }
  });

  newProblemBtn.addEventListener('click', ()=>{
    playSound('reset');
    generateProblem();
  });

  resetBtn.addEventListener('click', ()=>{
    playSound('reset');
    resetCurrentProblemView();
  });

  sideDemoBtn.addEventListener('click', ()=>{
    playSound('demo');
    if(quizMode) exitQuizMode();
    practiceMode = false;
    setModeBanner("Demo Mode Activated","demo");
    generateProblem();
    updateModeButtons();
  });

  sidePracticeBtn.addEventListener('click', ()=>{
    playSound('demo');
    if(quizMode) exitQuizMode();
    practiceMode = true;
    setModeBanner("Practice Mode Activated","practice");
    generateProblem();
    updateModeButtons();
  });

  sideQuizBtn.addEventListener('click', ()=>{
    playSound('demo');
    if(!quizMode){
      enterQuizMode();
    } else {
      exitQuizMode();
    }
  });

  barsEl.addEventListener('click', (e)=>{
    const seg = e.target.closest('.segment');
    if(!seg || seg.classList.contains('filler')) return;
    if(seg.dataset.active === 'true' || seg.dataset.activeGap === 'true'){
      seg.classList.toggle('touched');
    }
  });

  quizCheckBtn.addEventListener('click', ()=>{
    if(!quizMode) return;
    checkQuizAnswer();
  });

  quizNextBtn.addEventListener('click', ()=>{
    if(!quizMode) return;
    gotoQuizNext();
  });

  quizPrevBtn.addEventListener('click', ()=>{
    if(!quizMode) return;
    gotoQuizPrev();
  });

  quizOverlayClose.addEventListener('click', ()=>{
    closeQuizOverlay();
    exitQuizMode();
  });

  quizOverlay.addEventListener('click', (e)=>{
    if(e.target === quizOverlay){
      closeQuizOverlay();
      exitQuizMode();
    }
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      if(quizMode){
        e.preventDefault();
        checkQuizAnswer();
      } else if(!mainActionBtn.disabled){
        e.preventDefault();
        mainActionBtn.click();
      }
    }
    if(e.key === 'Escape' && isFullscreen){
      e.preventDefault();
      exitFullscreen();
    }
  });

  // Fullscreen toggle ---------------------------------------------------
  function enterFullscreen(){
    isFullscreen = true;
    cardRoot.classList.add('fullscreen');
    document.body.classList.add('fullscreen-active');
    fullscreenBtn.textContent = 'Exit full screen';
    fullscreenBtn.title = 'Exit full screen (Esc to exit)';
  }

  function exitFullscreen(){
    isFullscreen = false;
    cardRoot.classList.remove('fullscreen');
    document.body.classList.remove('fullscreen-active');
    fullscreenBtn.textContent = 'Full screen';
    fullscreenBtn.title = 'Enter full screen';
  }

  fullscreenBtn.addEventListener('click', ()=>{
    if(isFullscreen){
      exitFullscreen();
    } else {
      enterFullscreen();
    }
  });

  // Init ---------------------------------------------------------------
  generateProblem();
  updateModeButtons();
  setModeBanner("Demo Mode Activated","demo");
})();
</script>
</body>
</html>
